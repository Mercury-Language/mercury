#-----------------------------------------------------------------------------#
# Copyright (C) 1998-2005 The University of Melbourne.
# This file may only be copied under the terms of the GNU General
# Public License - see the file COPYING in the Mercury distribution.
#-----------------------------------------------------------------------------#

# browser/Mmakefile - this is the Mmakefile for building the Mercury
# browser library, which also includes other functionality needed
# by Mercury debuggers.

# Since the code in this directory is intended to be invoked only from
# the trace library, which turns off tracing in the Mercury code it calls,
# compiling the modules in this directory with tracing on only makes
# the generated code much bigger. However, since all Mercury code
# in an executable must be of the same grade, we need to be able to
# compile the modules in this directory in debug grades as well.

# Specify which files to check for namespace cleanliness, and which name
# prefixes are allowed.

CHECK_HDRS  =
CHECK_MHDRS = $(mer_browser.mhs)
CHECK_OBJS  = $(mer_browser.os)
ALLOW_LIB_PREFIX=yes
ALLOW_BROWSER_PREFIX=yes

MERCURY_DIR=..
LINK_STDLIB_ONLY=yes
include $(MERCURY_DIR)/Mmake.common
-include Mmake.browser.params

# Module-specific options should go in Mercury.options so they
# can be found by `mmc --make'.
include Mercury.options

MAIN_TARGET=main

MERCURY_MAIN_LIB_MODULES=$(BROWSER_LIB_NAME) $(MDBCOMP_LIB_NAME)
MERCURY_MAIN_MODULES=$(MERCURY_MAIN_LIB_MODULES) browse_test declarative_test

DEPENDS =	$(patsubst %,%.depend,$(MERCURY_MAIN_MODULES))
INTS_TARGETS =	$(patsubst %,%.ints,$(MERCURY_MAIN_MODULES))
INT3S_TARGETS =	$(patsubst %,%.int3s,$(MERCURY_MAIN_MODULES))
LIBS =		$(patsubst %,lib%,$(MERCURY_MAIN_LIB_MODULES))
CHECKS =	$(patsubst %,%.check,$(MERCURY_MAIN_LIB_MODULES))

#-----------------------------------------------------------------------------#

# Specify which compilers to use to compile the library.
# Don't change these without good reason - if you want to do a temporary
# change, change ../Mmake.params, or create Mmake.browser.params.

CFLAGS	+=	$(DLL_CFLAGS) -I$(TRACE_DIR)
MLFLAGS +=	-R$(FINAL_INSTALL_MERC_LIB_DIR)	\
		-R$(FINAL_INSTALL_MERC_GC_LIB_DIR)
MCFLAGS +=	-R$(FINAL_INSTALL_MERC_LIB_DIR)	\
		-R$(FINAL_INSTALL_MERC_GC_LIB_DIR)
MLLIBS +=	$(SOCKET_LIBRARY) $(NSL_LIBRARY) $(DL_LIBRARY)	\
		$(READLINE_LIBRARIES)

#-----------------------------------------------------------------------------#

# Set the install name for Darwin shared libraries.  We disable the
# --shlib-linker-use-install-name mmc option so that the -install_name linker
# option is not passed in the .dep files.  We do this to avoid a problem when
# building from the C source distribution:  if the C source distribution is
# generated on a non-Darwin system then the -install_name option is not passed
# in the .dep files, so it must be passed here, however if a C source
# distribution is generated on a Darwin system then by default the
# -install_name option will be passed in the .dep files which will cause it to
# be passed twice (here and in the .dep files) which is not allowed by the 
# linker, so we disable the mmc option which causes the -install_name option
# to be passed in the .dep files.

MCFLAGS += --no-shlib-linker-use-install-name
LD_LIBFLAGS-libmer_browser.dylib = -install_name \
	$(FINAL_INSTALL_MERC_LIB_DIR)/libmer_browser.dylib
LD_LIBFLAGS-libmer_mdbcomp.dylib = -install_name \
	$(FINAL_INSTALL_MERC_LIB_DIR)/libmer_mdbcomp.dylib

#-----------------------------------------------------------------------------#

JAVACFLAGS = -classpath $(LIBRARY_DIR)

MTAGS	=	$(SCRIPTS_DIR)/mtags

LN	=	ln

#-----------------------------------------------------------------------------#

# The IL and Java implementations of the standard library are not yet complete,
# so we need to pass `--allow-stubs' to get them to compile.
# Since the standard library is compiled with `--halt-at-warn',
# we also need `--no-warn-stubs'.
ifneq ("$(filter il% java%,$(GRADE))","")
MCFLAGS += --allow-stubs --no-warn-stubs
endif

#-----------------------------------------------------------------------------#

# Stuff for Windows DLLS using gnu-win32

ifeq ($(USE_DLLS),yes)

# XXX what do we need here for MDBCOMP_LIB_NAME?
DLL_CFLAGS = -Dlib$(BROWSER_LIB_NAME)_DEFINE_DLL

include $(MERCURY_DIR)/Makefile.DLLs

else

DLL_CFLAGS =
DLL_DEF_LIB =

endif

#-----------------------------------------------------------------------------#

# targets

.PHONY: main
main:	library $(TAGS_FILE_EXISTS)

.PHONY: all
all:	library $(TAGS_FILE_EXISTS) browse_test declarative_test

.PHONY: library
library: $(LIBS)

.PHONY: depend
depend:	$(DEPENDS)
$(DEPENDS): Mercury.modules

# This directory contains two libraries, mer_browser and mer_mdbcomp,
# and mer_browser depends on mer_mdbcomp.  But Mmake will by default
# assume that each library contains any file referenced from the
# top-level module which occurs in the current directory, which leads
# it to incorrectly assume that the mer_browser library should include
# the mdbcomp.m and program_representation.m files.
# To avoid this problem, we temporarily rename those files away
# when building the dependencies for mer_browser.
#
# We use the phony .NOTPARALLEL target to disable parallel make,
# to ensure that we don't try to execute any other rule while
# the files are renamed.
# We also need to be careful to ensure that the files get renamed
# back properly even if making the dependencies fails or a signal occurs.
# XXX This is all a bit hacky.

.NOTPARALLEL:

$(BROWSER_LIB_NAME).dep $(BROWSER_LIB_NAME).depend:
	trap 'mv RENAMED_mdbcomp.m mdbcomp.m; \
		mv RENAMED_program_representation.m program_representation.m; \
		exit 1' 1 2 3 13 15; \
	mv mdbcomp.m RENAMED_mdbcomp.m; \
	mv program_representation.m RENAMED_program_representation.m ;\
	$(MCD) $(ALL_GRADEFLAGS) $(ALL_MCDFLAGS) $*; \
	status=$$?; \
	mv RENAMED_mdbcomp.m mdbcomp.m; \
	mv RENAMED_program_representation.m program_representation.m; \
	exit $$status

lib$(BROWSER_LIB_NAME).so: lib$(MDBCOMP_LIB_NAME).so
lib$(BROWSER_LIB_NAME).dylib: lib$(MDBCOMP_LIB_NAME).dylib
lib$(BROWSER_LIB_NAME): lib$(MDBCOMP_LIB_NAME)
lib$(BROWSER_LIB_NAME).int3s: lib$(MDBCOMP_LIB_NAME).int3s
lib$(BROWSER_LIB_NAME).ints: lib$(MDBCOMP_LIB_NAME).ints
lib$(BROWSER_LIB_NAME).cs: lib$(MDBCOMP_LIB_NAME).cs
lib$(BROWSER_LIB_NAME).ss: lib$(MDBCOMP_LIB_NAME).ss
lib$(BROWSER_LIB_NAME).ils: lib$(MDBCOMP_LIB_NAME).ils
lib$(BROWSER_LIB_NAME).javas: lib$(MDBCOMP_LIB_NAME).javas
lib$(BROWSER_LIB_NAME).check: lib$(MDBCOMP_LIB_NAME).check
$($(BROWSER_LIB_NAME).ints): $($(MDBCOMP_LIB_NAME).ints)
$($(BROWSER_LIB_NAME).cs): $($(MDBCOMP_LIB_NAME).cs)
$($(BROWSER_LIB_NAME).ss): $($(MDBCOMP_LIB_NAME).ss)
$($(BROWSER_LIB_NAME).ils): $($(MDBCOMP_LIB_NAME).ils)
$($(BROWSER_LIB_NAME).javas): $($(MDBCOMP_LIB_NAME).java_dates)
$($(BROWSER_LIB_NAME).c_dates): $($(MDBCOMP_LIB_NAME).c_dates)
$($(BROWSER_LIB_NAME).s_dates): $($(MDBCOMP_LIB_NAME).s_dates)
$($(BROWSER_LIB_NAME).il_dates): $($(MDBCOMP_LIB_NAME).il_dates)
$($(BROWSER_LIB_NAME).java_dates): $($(MDBCOMP_LIB_NAME).java_dates)

# This directory contains source files for which the module
# name doesn't match the file name, so smart recompilation
# won't work without the Mercury.modules file.
.PHONY: Mercury.modules
Mercury.modules:
	$(MC) $(ALL_MCFLAGS) -f *.m

.PHONY: check
check:	$(CHECKS)

.PHONY: all-ints 
all-ints: ints int3s

.PHONY: ints 
ints:	$(INTS_TARGETS)

.PHONY: int3s 
int3s:	$(INT3S_TARGETS)

#-----------------------------------------------------------------------------#

tags:	$(MTAGS) $($(BROWSER_LIB_NAME).ms) $($(MDBCOMP_LIB_NAME).ms)
	$(MTAGS) $($(BROWSER_LIB_NAME).ms) $($(MDBCOMP_LIB_NAME).ms) \
		../library/*.m

.PHONY: tags_file_exists
tags_file_exists:
	@if test ! -f tags; then echo making tags; \
	$(MTAGS) $($(BROWSER_LIB_NAME).ms) $($(MDBCOMP_LIB_NAME).ms) \
		../library/*.m ; fi

$(BROWSER_LIB_NAME).stats: $(COMPILER_DIR)/source_stats.awk \
		$($(BROWSER_LIB_NAME).ms)
	awk -f $(COMPILER_DIR)/source_stats.awk \
		`vpath_find $($(BROWSER_LIB_NAME).ms)` > $@

$(MDBCOMP_LIB_NAME).stats: $(COMPILER_DIR)/source_stats.awk \
		$($(MDBCOMP_LIB_NAME).ms)
	awk -f $(COMPILER_DIR)/source_stats.awk \
		`vpath_find $($(MDBCOMP_LIB_NAME).ms)` > $@

#-----------------------------------------------------------------------------#

.PHONY: dates
dates:
	touch $($(BROWSER_LIB_NAME).dates) $($(MDBCOMP_LIB_NAME).dates)

#-----------------------------------------------------------------------------#

#
# Some Java compilers require the Java source files to be put in directories
# which match their package names.  But the Mercury compiler generates them
# with the package name prefixed to the file name with a ".", not a "/".
# So we copy the Java source files to where the Java compiler expects them to be.
#
# XXX This is a hack.  We ought to change the Mercury compiler so that it
# generates the Java files with the right names in the first place.
#

mdb/%.java: mdb.%.java
	[ -d mdb ] || mkdir mdb
	cp $< $@

mdbcomp/%.java: mdbcomp.%.java
	[ -d mdbcomp ] || mkdir mdbcomp
	cp $< $@

RENAMED_JAVAS = $($(BROWSER_LIB_NAME).javas:mdb.%.java=mdb/%.java) \
	$($(MDBCOMP_LIB_NAME).javas:mdbcomp.%.java=mdbcomp/%.java)

RENAMED_CLASSES = $($(BROWSER_LIB_NAME).classes:mdb.%.class=mdb/%.class) \
	$($(MDBCOMP_LIB_NAME).classes:mdbcomp.%.class=mdbcomp/%.class)

.PHONY: javas
javas: $(RENAMED_JAVAS)

.PHONY: classes
classes: $(RENAMED_JAVAS)
	$(JAVAC) $(ALL_JAVACFLAGS) -d $(classes_subdir) $(RENAMED_JAVAS)

#-----------------------------------------------------------------------------#

.PHONY: os cs ss ils
ifeq ($(MMAKE_USE_MMC_MAKE),no)
os: $($(BROWSER_LIB_NAME).os) $($(MDBCOMP_LIB_NAME).os)
cs: $($(BROWSER_LIB_NAME).cs) $($(MDBCOMP_LIB_NAME).cs)
ss: $($(BROWSER_LIB_NAME).ss) $($(MDBCOMP_LIB_NAME).ss)
ils: $($(BROWSER_LIB_NAME).ils) $($(MDBCOMP_LIB_NAME).ils)
else
os: $(BROWSER_LIB_NAME).os $(MDBCOMP_LIB_NAME).os
cs: $(BROWSER_LIB_NAME).cs $(MDBCOMP_LIB_NAME).cs
ss: $(BROWSER_LIB_NAME).ss $(MDBCOMP_LIB_NAME).ss
ils: $(BROWSER_LIB_NAME).ils $(MDBCOMP_LIB_NAME).ils
endif

#-----------------------------------------------------------------------------#

# Ensure we recompile mdb__version if VERSION is changed.
$(os_subdir)mdb.o \
$(os_subdir)mdb.pic_o \
$(os_subdir)mdbcomp.o \
$(os_subdir)mdbcomp.pic_o \
        : $(RUNTIME_DIR)/mercury_conf.h

#-----------------------------------------------------------------------------#

realclean_local:
	rm -f Mercury.modules tags

#-----------------------------------------------------------------------------#

# Installation targets

.PHONY: install
install: install_init install_library

.PHONY: install_dirs
install_dirs:
	[ -d $(INSTALL_MODULE_DIR) ] || mkdir -p $(INSTALL_MODULE_DIR)
	[ -d $(INSTALL_MERC_LIB_DIR) ] || mkdir -p $(INSTALL_MERC_LIB_DIR)

ifneq ("$(filter il% java%,$(GRADE))","")

# there is no browser in the .NET and Java backends

.PHONY: install_init
install_init: 

.PHONY: install_library
install_library:

else 

.PHONY: install_init
install_init: $(BROWSER_LIB_NAME).init $(MDBCOMP_LIB_NAME).init install_dirs
	cp `vpath_find $(BROWSER_LIB_NAME).init` $(INSTALL_MODULE_DIR)
	cp `vpath_find $(MDBCOMP_LIB_NAME).init` $(INSTALL_MODULE_DIR)

.PHONY: install_library
install_library: \
		lib$(BROWSER_LIB_NAME).$A \
		lib$(BROWSER_LIB_NAME).$(EXT_FOR_SHARED_LIB) \
		lib$(MDBCOMP_LIB_NAME).$A \
		lib$(MDBCOMP_LIB_NAME).$(EXT_FOR_SHARED_LIB) \
		install_dirs
	cp `vpath_find lib$(BROWSER_LIB_NAME).$A \
		lib$(BROWSER_LIB_NAME).$(EXT_FOR_SHARED_LIB)` \
		$(INSTALL_MERC_LIB_DIR)
	cp `vpath_find lib$(MDBCOMP_LIB_NAME).$A \
		lib$(MDBCOMP_LIB_NAME).$(EXT_FOR_SHARED_LIB)` \
		$(INSTALL_MERC_LIB_DIR)
	$(RANLIB) $(INSTALL_MERC_LIB_DIR)/lib$(BROWSER_LIB_NAME).$A
	$(RANLIB) $(INSTALL_MERC_LIB_DIR)/lib$(MDBCOMP_LIB_NAME).$A

endif
