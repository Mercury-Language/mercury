#! /bin/sh
# @configure_input@
#---------------------------------------------------------------------------#
# Copyright (C) 1995 University of Melbourne.
# This file may only be copied under the terms of the GNU General
# Public License - see the file COPYING in the Mercury distribution.
#---------------------------------------------------------------------------#
#
# MGNUC - Mercury GNU C
#
# Usage: mgnuc [<options>] [-- <gcc options>] files...
# Options:
# -v, --verbose
#	Echo gcc command before executing it.
# --no-ansi
#	Don't pass -ansi.
# --no-check
#	Don't pass any of the -W options.
# -s <grade>, --grade <grade>
#	Select optimization/debug/gc options according to <grade>, which
#	must be one of debug, none, jump, asm_jump, reg, fast, or asm_fast,
#	or one of those with .gc appended.
#
# This runs gcc with all warnings enabled, except for the following
# exceptions:
#
# -Wredundant-decls	causes too many complaints in system header files
# -Wconversion		really only intended to help people using `unprotoize'
# -Waggregate-return	not useful, IMHO
#
# -Wcast-align 		causes redundant warnings in memory.c
# -pedantic		causes unsuppressable warnings about LVALUE_CAST()
# -Wnested-externs	causes unsuppressable warnings about callentry()
# -Wid-clash-31 	causes warnings about entry_mercury__xxx ...
# -Wenum-clash 		is for C++ only
# -Wunused		causes various spurious warnings
#
# Environment variables: MERCURY_C_INCL_DIR, MERCURY_DEFAULT_GRADE.

C_INCL_DIR=${MERCURY_C_INCL_DIR=@LIBDIR@/inc}
DEFAULT_GRADE=${MERCURY_DEFAULT_GRADE=@DEFAULT_GRADE@}
CC=${MERCURY_C_COMPILER=@CC@}

ANSI_OPTS="-ansi"
CHECK_OPTS="
      -Wall -Wwrite-strings -Wpointer-arith -Wcast-qual -Wtraditional -Wshadow
      -Wstrict-prototypes -Wmissing-prototypes -Wno-unused"
OPT_OPTS="-O2 -fomit-frame-pointer -DSPEED"
DEBUG_OPTS="-g"

grade=$DEFAULT_GRADE
verbose=false

while true; do
    case "$1" in
	--no-ansi)
		ANSI_OPTS=
		shift
		;;
	--no-check)
		CHECK_OPTS=
		shift
		;;
	-v|--verbose)
		verbose=true
		shift
		;;
	-s|--grade)
		shift
		grade="$1";
		shift
		;;
	-s*)
		grade="` expr $1 : '-s\(.*\)' `"
		shift
		;;
	--)
		shift
		break
		;;
	*)
		break
		;;
    esac
done

case "$grade" in
	*.gc)	GC_OPTS="-DCONSERVATIVE_GC"
		grade="` expr $grade : '\(.*\).gc' `"
		;;
	*)
		GC_OPTS=""
		;;
esac

case "$grade" in
	asm_fast)
		GRADE_OPTS="$OPT_OPTS -DUSE_GCC_GLOBAL_REGISTERS
				-DUSE_ASM_LABELS -DUSE_GCC_NONLOCAL_GOTOS"
		;;
	fast)
		GRADE_OPTS="$OPT_OPTS
			-DUSE_GCC_GLOBAL_REGISTERS -DUSE_GCC_NONLOCAL_GOTOS"
		;;
	reg)
		GRADE_OPTS="$OPT_OPTS
			-DUSE_GCC_GLOBAL_REGISTERS"
		;;
	asm_jump)
		GRADE_OPTS="$OPT_OPTS
			-DUSE_ASM_LABELS -DUSE_GCC_NONLOCAL_GOTOS"
		;;
	jump)
		GRADE_OPTS="$OPT_OPTS
			-DUSE_GCC_NONLOCAL_GOTOS"
		;;
	none)
		GRADE_OPTS="$OPT_OPTS"
		;;
	init)
		echo "$0: the \`-s init' option is no longer supported" 1>&2
		exit 1
		;;
	debug)
		GRADE_OPTS="$DEBUG_OPTS"
		;;
	*)
		echo "$0: invalid grade \`$grade'" 1>&2;
		exit 1
esac

#
# Special case hacks for particular architectures
# Any code here needs to be duplicated in ../configure.in.
#

ARCH_OPTS=""
case @FULLARCH@ in
	mips-sgi-irix5.*)
		# nonlocal gotos don't work with PIC, which is the
		# default for Irix 5, so if nonlocal gotos are enabled
		# we need to disable PIC with -non_shared -mno-abicalls.
		case $GRADE_OPTS in
			*-DUSE_GCC_NONLOCAL_GOTOS*)
LIBRARY_PATH="/usr/contrib/lib/nonshared:/usr/lib/nonshared:$LIBRARY_PATH"
				export LIBRARY_PATH
				ARCH_OPTS="-non_shared -mno-abicalls"
			;;
		esac
	;;
esac

if $verbose; then
	echo $CC -I $C_INCL_DIR $ARCH_OPTS $HOST_OPTS $ANSI_OPTS $CHECK_OPTS \
		$GRADE_OPTS $GC_OPTS "$@"
fi
exec $CC -I $C_INCL_DIR $ARCH_OPTS $HOST_OPTS $ANSI_OPTS $CHECK_OPTS \
	$GRADE_OPTS $GC_OPTS "$@"
